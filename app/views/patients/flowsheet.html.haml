%div.span12
  %h1 Flowsheet
  = form_tag('/patient_flowsheet_rows', :class => "edit_patient_flowsheet") do
    = hidden_field_tag :patient_flowsheet_id, @flowsheet.id
    = hidden_field_tag :patient_id, @patient.id
    = hidden_field_tag :template, @flowsheet.template

  #flowsheet
    %table
      %tr.heading
        = render :partial => "flowsheets/#{@flowsheet.template}_header"

      - @flowsheet.patient_flowsheet_rows.each do |row|
        - @patient_id = @flowsheet.patient_id
        - @patient_flowsheet_row = row
        %tr
          %td
            = render :partial => "flowsheets/#{@flowsheet.template}_row"

  = button_tag "Add Row", {:id => :add_row}

:javascript
  $(document).ready(function() {
    $("#add_row").click(function() { newFlowsheetRow() });
    bindGUIElements();
    $(".edit_patient_flowsheet_row input:text").not(".datepicker").blur(function() {
      console.debug(this);
      //updateFlowsheetResponse(this);
    });
    $(".edit_patient_flowsheet_row .datepicker").change(function() {
      console.debug(this);
      //updateFlowsheetResponse(this);
    });
  });

  function fetchFlowsheetRow(url, replaceElement) {
    $.ajax({
      type: "GET",
      url: url,
      contentType: 'application/json',
      success: function(data) {
        if (replaceElement != undefined) {
          replaceFlowsheetRow(data, replaceElement);
        }
        else {
          addFlowsheetRow(data);
        }
      },
      error: function(err) {
        if (err.status == 200) { addFlowsheetRow(err.responseText); }
      }
    });
  }

  function newFlowsheetRow() {
    fetchFlowsheetRow("/patient_flowsheet_rows/new?patient_id=#{@patient.id}&template=#{@flowsheet.template}&patient_flowsheet_id=#{@flowsheet.id}");
  }

  function editFlowsheetRow(id, replaceElement) {
    fetchFlowsheetRow("/patient_flowsheet_rows/" + id + "/edit", replaceElement);
  }

  function addFlowsheetRow(html) {
    $("#flowsheet table tr:last").after($(html));
    bindGUIElements();
    $("#flowsheet input:text").not(".datepicker").blur(function() {
      console.debug(this);
      //saveFlowsheetResponse(this);
    });
    $("#flowsheet .datepicker").change(function() {
      console.debug(this);
      //saveFlowsheetResponse(this);
    });
  }

  function replaceFlowsheetRow(html, replaceElement) {
    replaceElement.replaceWith(html);
    bindGUIElements();
    $("#flowsheet input:text").not(".datepicker").blur(function() {
      updateFlowsheetResponse(this);
    });
    $(".edit_patient_flowsheet_row .datepicker").change(function() {
      updateFlowsheetResponse(this);
    });
  }

  function saveFlowsheetResponse(element) {
    form = $(".edit_patient_flowsheet");
    if (form.length) {
      $.ajax({
        type: "POST",
        url: '/patient_flowsheet_rows/',
        data: $(element).closest("tr").find("input").serialize() + "&" + form.serialize(),
        success: function(data) {
          convertToEditFlowsheetRow(form, data);
        },
        error: function(err) {
          if (err.status == 200) { convertToEditFlowsheetRow(form, err.responseText); }
        }
      });
    }
  }

  function updateFlowsheetResponse(element) {
    form = $(".edit_patient_flowsheet");
    if (form.length) {
      $.ajax({
        type: "PUT",
        url: '/patient_flowsheet_rows/',
        data: $(element).closest("tr").find("input").serialize() + "&" + form.serialize(),
        success: function(data) {},
        error: function(err) {}
      });
    }
  }

  function convertToEditFlowsheetRow(row, data) {
    editFlowsheetRow(data.id, row);
  }
